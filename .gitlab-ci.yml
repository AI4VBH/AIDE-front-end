image: node:14

include:
  - /.gitlab/templates/.service.yml

variables:
  PROJECT_ROOT: "./"
  SERVICE: aide-frontend
  
cache:
    - paths:
        - "/node_modules"

test-ui-headless:
    stage: test
    needs: [build-ui]
    image: mcr.microsoft.com/playwright:focal
    before_script:
        - npm ci
    script:
        - npm run tests:ui_headless
    after_script:
        - cp -r $CI_PROJECT_DIR/tests/ui_integration/output/ ci_artifacts/
    artifacts:
        name: "$CI_JOB_STAGE-$CI_COMMIT_REF_NAME"
        paths:
            - ci_artifacts/
        when: always

sonarqube-check:
    image: 
        name: sonarsource/sonar-scanner-cli:latest
        entrypoint: [""]
    variables:
        SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"  # Defines the location of the analysis task cache
        GIT_DEPTH: "0"  # Tells git to fetch all the branches of the project, required by the analysis task
    cache:
        key: "${CI_JOB_NAME}"
        paths:
        - .sonar/cache
    script: 
        - sonar-scanner
    allow_failure: true
    only:
        - merge_requests
        - master # or the name of your main branch
