image: node:14

include:
  - /.gitlab/templates/.service.yml

variables:
  PROJECT_ROOT: "./"
  SERVICE: aide-frontend

cache:
    - paths:
        - "/node_modules"

build-ui:
    stage: build
    before_script:
        - npm ci
    script:
        - npm run build

test_ui_headless:
    stage: test_ui_integration
    image: mcr.microsoft.com/playwright:v1.5.1-focal
    needs: []
    before_script:
        - export VUE_APP_AUTH_ENABLED=false
    script:
        - npm i --no-optional -f
        - npm run tests:ui_ci
    after_script:
        - cp -r $CI_PROJECT_DIR/tests/ui_integration/output/ ci_artifacts/
        - cp -r $CI_PROJECT_DIR/tests/ui_integration/screenshots/diff ci_artifacts/

    artifacts:
        name: "$CI_JOB_STAGE-$CI_COMMIT_REF_NAME"
        paths:
            - ci_artifacts/
        when: always
    only: 
        - merge_requests

sonarqube-check:
    stage: sast
    image: 
        name: sonarsource/sonar-scanner-cli:latest
        entrypoint: [""]
    variables:
        SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"  # Defines the location of the analysis task cache
        GIT_DEPTH: "0"  # Tells git to fetch all the branches of the project, required by the analysis task
    cache:
        key: "${CI_JOB_NAME}"
        paths:
        - .sonar/cache
    script: 
        - sonar-scanner
    allow_failure: true
    only:
        - merge_requests
        - master # or the name of your main branch
